# Architecture Summary: Multi-Module Deployment

## Repository Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   YOUR 4 REPOSITORIES                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  dev-deployment          â”‚  â”‚  centerlized-pipline-    â”‚
â”‚  (Developer Repo)        â”‚  â”‚  (Controller Repo)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Accounts/               â”‚  â”‚  main.tf          â† NEW  â”‚
â”‚    arj-wkld-a-nonprd/    â”‚  â”‚  variables.tf  â† UPDATED â”‚
â”‚      us-east-1/          â”‚  â”‚  outputs.tf    â† UPDATED â”‚
â”‚        app.tfvars    â—„â”€â”€â”€â”¼â”€â”€â”¼â”€ providers.tf            â”‚
â”‚                          â”‚  â”‚  .github/workflows/      â”‚
â”‚  .github/workflows/      â”‚  â”‚    controller-simple.yml â”‚
â”‚    trigger-controller.ymlâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tf-module               â”‚  â”‚  OPA-Poclies             â”‚
â”‚  (Terraform Modules)     â”‚  â”‚  (Policy Definitions)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Module/                 â”‚  â”‚  aws/s3/                 â”‚
â”‚    S3/                   â”‚  â”‚  aws/iam/                â”‚
â”‚      main.tf             â”‚  â”‚  lib/                    â”‚
â”‚      variables.tf        â”‚  â”‚  terraform/              â”‚
â”‚      outputs.tf          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚    KMS/                  â”‚
â”‚      main.tf             â”‚
â”‚      variables.tf        â”‚
â”‚      outputs.tf          â”‚
â”‚    IAM/                  â”‚
â”‚      main.tf             â”‚
â”‚      variables.tf        â”‚
â”‚      outputs.tf          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## main.tf Structure (NEW)

```hcl
# centerlized-pipline-/main.tf

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TERRAFORM CONFIG                     â”‚
â”‚  â€¢ Required version >= 1.0                             â”‚
â”‚  â€¢ AWS provider ~> 6.7                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA SOURCES                         â”‚
â”‚  â€¢ aws_caller_identity (current account)               â”‚
â”‚  â€¢ aws_region (current region)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LOCAL PROCESSING                     â”‚
â”‚                                                         â”‚
â”‚  1. Load YAML config (if provided)                     â”‚
â”‚  2. Merge with tfvars variables                        â”‚
â”‚  3. Process S3 buckets:                                â”‚
â”‚     - Load bucket policies from files                  â”‚
â”‚     - Remove metadata fields                           â”‚
â”‚     - Normalize KMS key IDs                            â”‚
â”‚  4. Process KMS keys:                                  â”‚
â”‚     - Load KMS policies from files                     â”‚
â”‚     - Merge tags                                       â”‚
â”‚  5. Process IAM resources:                             â”‚
â”‚     - Merge users, roles, policies                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MODULE: S3                           â”‚
â”‚                                                         â”‚
â”‚  Pattern: count (conditional)                          â”‚
â”‚  Source: ../tf-module/Module/S3                        â”‚
â”‚  Inputs:                                               â”‚
â”‚    â€¢ common_tags = var.common_tags                     â”‚
â”‚    â€¢ s3_buckets  = local.processed_s3_buckets (map)    â”‚
â”‚                                                         â”‚
â”‚  Creates:                                              â”‚
â”‚    â€¢ aws_s3_bucket                                     â”‚
â”‚    â€¢ aws_s3_bucket_versioning                          â”‚
â”‚    â€¢ aws_s3_bucket_server_side_encryption_configurationâ”‚
â”‚    â€¢ aws_s3_bucket_lifecycle_configuration             â”‚
â”‚    â€¢ aws_s3_bucket_policy                              â”‚
â”‚    â€¢ aws_s3_bucket_public_access_block                 â”‚
â”‚    â€¢ ... and more                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MODULE: KMS                          â”‚
â”‚                                                         â”‚
â”‚  Pattern: for_each (per key)                           â”‚
â”‚  Source: ../tf-module/Module/KMS                       â”‚
â”‚  Inputs (per key):                                     â”‚
â”‚    â€¢ description                                       â”‚
â”‚    â€¢ key_usage                                         â”‚
â”‚    â€¢ key_spec                                          â”‚
â”‚    â€¢ enable_key_rotation                               â”‚
â”‚    â€¢ policy_content                                    â”‚
â”‚    â€¢ aliases                                           â”‚
â”‚    â€¢ tags                                              â”‚
â”‚                                                         â”‚
â”‚  Creates (per key):                                    â”‚
â”‚    â€¢ aws_kms_key                                       â”‚
â”‚    â€¢ aws_kms_alias                                     â”‚
â”‚    â€¢ aws_kms_grant (optional)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MODULE: IAM                          â”‚
â”‚                                                         â”‚
â”‚  Pattern: count (conditional)                          â”‚
â”‚  Source: ../tf-module/Module/IAM                       â”‚
â”‚  Inputs:                                               â”‚
â”‚    â€¢ users    = local.merged_iam_users (map)           â”‚
â”‚    â€¢ roles    = local.merged_iam_roles (map)           â”‚
â”‚    â€¢ policies = local.merged_iam_policies (map)        â”‚
â”‚    â€¢ tags     = var.common_tags                        â”‚
â”‚                                                         â”‚
â”‚  Creates:                                              â”‚
â”‚    â€¢ aws_iam_user                                      â”‚
â”‚    â€¢ aws_iam_access_key                                â”‚
â”‚    â€¢ aws_iam_user_login_profile                        â”‚
â”‚    â€¢ aws_iam_role                                      â”‚
â”‚    â€¢ aws_iam_policy                                    â”‚
â”‚    â€¢ aws_iam_role_policy_attachment                    â”‚
â”‚    â€¢ ... and more                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OUTPUTS                              â”‚
â”‚                                                         â”‚
â”‚  Basic (main.tf):                                      â”‚
â”‚    â€¢ deployment_summary                                â”‚
â”‚    â€¢ s3_bucket_arns, s3_bucket_names                   â”‚
â”‚    â€¢ kms_key_ids, kms_key_arns                         â”‚
â”‚    â€¢ iam_user_arns, iam_role_arns                      â”‚
â”‚                                                         â”‚
â”‚  Detailed (outputs.tf):                                â”‚
â”‚    â€¢ s3_buckets_detailed                               â”‚
â”‚    â€¢ bucket_versioning, bucket_encryption              â”‚
â”‚    â€¢ kms_keys_detailed                                 â”‚
â”‚    â€¢ iam_users_detailed                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Deployment Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: Developer commits tfvars to dev-deployment repo    â”‚
â”‚                                                              â”‚
â”‚  File: Accounts/arj-wkld-a-nonprd/us-east-1/my-app.tfvars   â”‚
â”‚  Contains:                                                   â”‚
â”‚    â€¢ common_tags = { ... }                                   â”‚
â”‚    â€¢ s3_buckets  = { "bucket1" = { ... }, "bucket2" = {...}}â”‚
â”‚    â€¢ kms_keys    = { "key1" = { ... } }                     â”‚
â”‚    â€¢ iam_users   = { "user1" = { ... } }                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: GitHub Actions triggered                           â”‚
â”‚                                                              â”‚
â”‚  Workflow: .github/workflows/trigger-controller.yml          â”‚
â”‚  Event: pull_request on paths: Accounts/**/*.tfvars         â”‚
â”‚  Action: Calls centerlized-pipline-/controller-simple.yml   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: Controller workflow runs                           â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Job 1: Checkout all repos                            â”‚  â”‚
â”‚  â”‚   â€¢ actions/checkout@v4 (dev-deployment)             â”‚  â”‚
â”‚  â”‚   â€¢ actions/checkout@v4 (centerlized-pipline-)       â”‚  â”‚
â”‚  â”‚   â€¢ actions/checkout@v4 (tf-module)                  â”‚  â”‚
â”‚  â”‚   â€¢ actions/checkout@v4 (OPA-Poclies)                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Job 2: Discover deployments                          â”‚  â”‚
â”‚  â”‚   â€¢ Run: s3-deployment-manager.py discover           â”‚  â”‚
â”‚  â”‚   â€¢ Finds: my-app.tfvars (changed file)              â”‚  â”‚
â”‚  â”‚   â€¢ Output: deployments.json                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Job 3: Terraform init                                â”‚  â”‚
â”‚  â”‚   â€¢ cd centerlized-pipline-                          â”‚  â”‚
â”‚  â”‚   â€¢ terraform init                                   â”‚  â”‚
â”‚  â”‚   â€¢ Downloads:                                       â”‚  â”‚
â”‚  â”‚     - Module/S3 from ../tf-module/                   â”‚  â”‚
â”‚  â”‚     - Module/KMS from ../tf-module/                  â”‚  â”‚
â”‚  â”‚     - Module/IAM from ../tf-module/                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Job 4: Terraform plan                                â”‚  â”‚
â”‚  â”‚   â€¢ Copy my-app.tfvars â†’ terraform.tfvars            â”‚  â”‚
â”‚  â”‚   â€¢ terraform plan -out=tfplan                       â”‚  â”‚
â”‚  â”‚   â€¢ Creates plan for:                                â”‚  â”‚
â”‚  â”‚     âœ“ 2 S3 buckets (module.s3)                       â”‚  â”‚
â”‚  â”‚     âœ“ 1 KMS key (module.kms)                         â”‚  â”‚
â”‚  â”‚     âœ“ 1 IAM user (module.iam)                        â”‚  â”‚
â”‚  â”‚   â€¢ terraform show -json tfplan > plan.json          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Job 5: OPA validation                                â”‚  â”‚
â”‚  â”‚   â€¢ opa eval -d OPA-Poclies/aws/ plan.json          â”‚  â”‚
â”‚  â”‚   â€¢ Validates:                                       â”‚  â”‚
â”‚  â”‚     âœ“ S3 encryption enabled                          â”‚  â”‚
â”‚  â”‚     âœ“ S3 versioning enabled                          â”‚  â”‚
â”‚  â”‚     âœ“ S3 public access blocked                       â”‚  â”‚
â”‚  â”‚     âœ“ KMS key rotation enabled                       â”‚  â”‚
â”‚  â”‚     âœ“ IAM user strong password policy                â”‚  â”‚
â”‚  â”‚   â€¢ Result: PASS or FAIL                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Job 6: Post PR comment                               â”‚  â”‚
â”‚  â”‚   â€¢ Convert plan to markdown                         â”‚  â”‚
â”‚  â”‚   â€¢ Post to PR:                                      â”‚  â”‚
â”‚  â”‚     ## Terraform Plan Summary                        â”‚  â”‚
â”‚  â”‚     âœ… OPA: PASS                                      â”‚  â”‚
â”‚  â”‚     ğŸ“¦ Resources to create:                          â”‚  â”‚
â”‚  â”‚       â€¢ 2 S3 buckets                                 â”‚  â”‚
â”‚  â”‚       â€¢ 1 KMS key                                    â”‚  â”‚
â”‚  â”‚       â€¢ 1 IAM user                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Job 7: Auto-merge or Auto-close                      â”‚  â”‚
â”‚  â”‚   â€¢ If OPA PASS:                                     â”‚  â”‚
â”‚  â”‚     âœ… Auto-merge PR                                  â”‚  â”‚
â”‚  â”‚   â€¢ If OPA FAIL:                                     â”‚  â”‚
â”‚  â”‚     âŒ Auto-close PR with reason                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: After merge - Apply workflow runs                  â”‚
â”‚                                                              â”‚
â”‚  Event: push to main branch                                 â”‚
â”‚  Action: terraform apply                                    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Deploys to AWS:                                      â”‚  â”‚
â”‚  â”‚   â€¢ 2 S3 buckets created                             â”‚  â”‚
â”‚  â”‚   â€¢ 1 KMS key created                                â”‚  â”‚
â”‚  â”‚   â€¢ 1 IAM user created                               â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚ State file saved:                                    â”‚  â”‚
â”‚  â”‚   s3://terraform-state/                              â”‚  â”‚
â”‚  â”‚     s3/arj-wkld-a-nonprd/us-east-1/my-app/           â”‚  â”‚
â”‚  â”‚       terraform.tfstate                              â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚ Contains ALL resources:                              â”‚  â”‚
â”‚  â”‚   â€¢ module.s3[0].aws_s3_bucket.buckets["bucket1"]    â”‚  â”‚
â”‚  â”‚   â€¢ module.s3[0].aws_s3_bucket.buckets["bucket2"]    â”‚  â”‚
â”‚  â”‚   â€¢ module.kms["key1"].aws_kms_key.this              â”‚  â”‚
â”‚  â”‚   â€¢ module.iam[0].aws_iam_user.users["user1"]        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Module Interface Patterns

### Pattern 1: S3 Module (Map-based, Count)

```
Input:  s3_buckets = { "key1" = {...}, "key2" = {...} }
        â†“
Module: count = length(s3_buckets) > 0 ? 1 : 0
        module.s3[0]
        â†“
Resources: for_each = var.s3_buckets
           aws_s3_bucket.buckets["key1"]
           aws_s3_bucket.buckets["key2"]
```

### Pattern 2: KMS Module (Per-key, For-each)

```
Input:  kms_keys = { "key1" = {...}, "key2" = {...} }
        â†“
Module: for_each = kms_keys
        module.kms["key1"]
        module.kms["key2"]
        â†“
Resources: Single key per module instance
           module.kms["key1"] â†’ aws_kms_key.this
           module.kms["key2"] â†’ aws_kms_key.this
```

### Pattern 3: IAM Module (Map-based, Count)

```
Input:  iam_users = { "user1" = {...}, "user2" = {...} }
        iam_roles = { "role1" = {...} }
        â†“
Module: count = (users + roles) > 0 ? 1 : 0
        module.iam[0]
        â†“
Resources: for_each = var.users
           aws_iam_user.users["user1"]
           aws_iam_user.users["user2"]
           
           for_each = var.roles
           aws_iam_role.roles["role1"]
```

## Key Benefits

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… ATOMIC DEPLOYMENTS                                   â”‚
â”‚     All modules deployed/destroyed together              â”‚
â”‚     Either all succeed or all rollback                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… SINGLE STATE FILE                                    â”‚
â”‚     No cross-state dependencies                          â”‚
â”‚     Easier to manage and reason about                    â”‚
â”‚     Clear ownership per deployment                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… POLICY VALIDATION                                    â”‚
â”‚     OPA validates ALL resources together                 â”‚
â”‚     Catches cross-resource policy violations             â”‚
â”‚     Consistent compliance enforcement                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… SIMPLIFIED DEPENDENCIES                              â”‚
â”‚     KMS keys and S3 buckets in same config               â”‚
â”‚     IAM roles and S3 policies coordinated                â”‚
â”‚     No manual ARN copying between configs                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… CONSISTENT TAGGING                                   â”‚
â”‚     common_tags applied across all modules               â”‚
â”‚     Per-resource tags merged with common tags            â”‚
â”‚     Easy compliance and cost tracking                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## What Changed

```diff
BEFORE:
centerlized-pipline-/
â”œâ”€â”€ providers.tf
â”œâ”€â”€ variables.tf
â””â”€â”€ outputs.tf
    â””â”€â”€ âŒ References module.s3 that doesn't exist
        â””â”€â”€ âŒ No main.tf to call modules

AFTER:
centerlized-pipline-/
â”œâ”€â”€ main.tf                          â† âœ… NEW
â”‚   â”œâ”€â”€ Calls module "s3"
â”‚   â”œâ”€â”€ Calls module "kms" (for_each)
â”‚   â””â”€â”€ Calls module "iam"
â”œâ”€â”€ providers.tf                     â† No change
â”œâ”€â”€ variables.tf                     â† âœ… Added kms_keys, iam_users, iam_roles
â””â”€â”€ outputs.tf                       â† âœ… Fixed references
```
