# =============================================================================
# CENTRALIZED TERRAFORM CONTROLLER - MANUAL MERGE APPROACH
# =============================================================================
name: ğŸ¯ Centralized Controller

on:
  repository_dispatch:
    types: [terraform_pr, terraform_apply]

permissions:
  id-token: write
  contents: read
  actions: read
  pull-requests: write
  issues: write

env:
  TERRAFORM_VERSION: '1.11.0'
  OPA_VERSION: '0.59.0'
  AWS_REGION: 'us-east-1'

jobs:
  # =============================================================================
  # VALIDATION JOB - Triggered by PR events
  # =============================================================================
  terraform-validation:
    name: ğŸ›¡ï¸ Terraform Validation
    runs-on: ubuntu-latest
    if: github.event.action == 'terraform_pr' || github.event.client_payload.action == 'validate'
    
    steps:
      - name: ğŸ“‹ Setup & Event Details
        id: setup
        run: |
          echo "ğŸ”” Source: ${{ github.event.client_payload.source_owner }}/${{ github.event.client_payload.source_repo }}"
          echo "ğŸ“‹ PR: #${{ github.event.client_payload.pr_number }} (${{ github.event.client_payload.pr_head_ref }})"
          echo "ğŸ¯ Action: Validation & Security Scan"

      - name: ğŸ”‘ Generate GitHub App Token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.GT_APP_ID }}
          private_key: ${{ secrets.GT_APP_PRIVATE_KEY }}

      - name: ğŸ“¥ Checkout Controller Repository
        uses: actions/checkout@v4
        with:
          repository: Terraform-centilazed-pipline/centerlized-pipline-
          path: controller
          token: ${{ steps.app-token.outputs.token }}

      - name: ğŸ“¥ Checkout Source Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.source_owner }}/${{ github.event.client_payload.source_repo }}
          ref: ${{ github.event.client_payload.pr_head_ref }}
          path: source-repo
          token: ${{ steps.app-token.outputs.token }}

      - name: ğŸ Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install pyyaml requests jq yq

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: ğŸ—ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ===== STEP 1: DISCOVER DEPLOYMENTS =====
      - name: ğŸ” Discover Deployments
        if: steps.changed-files.outputs.count > 0
        id: discover
        working-directory: source-repo
        env:
          TERRAFORM_DIR: ../controller
        run: |
          python3 ../controller/scripts/terraform-deployment-orchestrator.py discover \
            --changed-files "${{ steps.changed-files.outputs.files }}" \
            --output-summary deployments.json \
            --debug
          
          total=$(jq -r '.total_deployments // 0' deployments.json)
          echo "total=$total" >> $GITHUB_OUTPUT
          
          if [ "$total" -gt 0 ]; then
            echo "âœ… Found $total deployments"
            echo "has_deployments=true" >> $GITHUB_OUTPUT
            
            # Extract first tfvars file for pre-validation
            first_tfvars=$(jq -r '.deployments[0].tfvars_file // empty' deployments.json)
            echo "first_tfvars=$first_tfvars" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No deployments found"
            echo "has_deployments=false" >> $GITHUB_OUTPUT
          fi
     # ===== STEP 2: PRE-DEPLOYMENT VALIDATION (BEFORE terraform plan) =====
      - name: ğŸ” Pre-Deployment Validation
        if: steps.discover.outputs.has_deployments == 'true'
        id: pre_validation
        working-directory: source-repo
        continue-on-error: true
        run: |
          echo "ğŸ” Running pre-deployment validation..."
          echo "ğŸ“„ Validating: ${{ steps.discover.outputs.first_tfvars }}"
          echo "ğŸ‘¤ PR Author: ${{ github.event.client_payload.pr_author }}"
          
          # Run pre-deployment validator
          set +e
          python3 ../controller/scripts/pre-deployment-validator.py \
            "${{ steps.discover.outputs.first_tfvars }}" \
            "${{ github.event.client_payload.pr_author }}"
          
          validation_exit=$?
          set -e
          
          if [ -f pre-validation-comment.md ]; then
            echo "validation_comment_exists=true" >> $GITHUB_OUTPUT
          fi
          
          if [ $validation_exit -eq 0 ]; then
            echo "âœ… Pre-deployment validation passed"
            echo "validation_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Pre-deployment validation failed"
            echo "validation_passed=false" >> $GITHUB_OUTPUT
          fi
          
          exit $validation_exit

      - name: ğŸ’¬ Post Pre-Validation Comment
        if: steps.pre_validation.outputs.validation_comment_exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('source-repo/pre-validation-comment.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: '${{ github.event.client_payload.source_owner }}',
              repo: '${{ github.event.client_payload.source_repo }}',
              issue_number: ${{ github.event.client_payload.pr_number }},
              body: comment
            });

      - name: ğŸ›‘ Stop if Pre-Validation Failed
        if: steps.pre_validation.outputs.validation_passed == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            // Close the PR
            await github.rest.pulls.update({
              owner: '${{ github.event.client_payload.source_owner }}',
              repo: '${{ github.event.client_payload.source_repo }}',
              pull_number: ${{ github.event.client_payload.pr_number }},
              state: 'closed'
            });
            
            core.setFailed('âŒ Pre-deployment validation failed. PR closed.');
 
      - name: ğŸ›¡ï¸ Security Scan with Checkov
        if: steps.discover.outputs.has_deployments == 'true'
        id: security
        working-directory: source-repo
        run: |
          echo "ğŸ›¡ï¸ Running Checkov security scan..."
          
          # Install Checkov
          pip install checkov
          
          # Create results directory
          mkdir -p checkov-results
          
          # Run Checkov scan on Accounts directory
          checkov --framework terraform \
            --directory Accounts \
            --output json \
            --output-file-path checkov-results/results.json \
            --quiet --soft-fail --compact || true
          
          # Process results
          if [ -f "checkov-results/results.json" ]; then
            failed_checks=$(jq '.results.failed_checks | length' checkov-results/results.json 2>/dev/null || echo "0")
            passed_checks=$(jq '.results.passed_checks | length' checkov-results/results.json 2>/dev/null || echo "0")
            
            echo "ğŸ” Security scan completed: $failed_checks failed, $passed_checks passed"
            echo "failed_checks=$failed_checks" >> $GITHUB_OUTPUT
            echo "passed_checks=$passed_checks" >> $GITHUB_OUTPUT
            
            # Determine status
            if [ "$failed_checks" -gt 0 ]; then
              echo "scan_status=warning" >> $GITHUB_OUTPUT
              echo "scan_message=âš ï¸ Security issues found ($failed_checks)" >> $GITHUB_OUTPUT
            else
              echo "scan_status=passed" >> $GITHUB_OUTPUT
              echo "scan_message=âœ… Security scan passed" >> $GITHUB_OUTPUT
            fi
          else
            echo "scan_status=skipped" >> $GITHUB_OUTPUT
            echo "scan_message=âš ï¸ Security scan could not run" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“‹ Generate Terraform Plans
        if: steps.discover.outputs.has_deployments == 'true'
        id: plan
        working-directory: source-repo
        run: |
          echo "ğŸ“‹ Running terraform plan..."
          
          python ../controller/scripts/terraform-deployment-orchestrator.py \
            --action plan \
            --working-dir . \
            --deployments-json deployments.json \
            --output-summary plan-results.json \
            --debug
          
          if [ -f "plan-results.json" ]; then
            successful=$(jq '.summary.successful // 0' plan-results.json)
            failed=$(jq '.summary.failed // 0' plan-results.json)
            
            echo "plan_successful=$successful" >> $GITHUB_OUTPUT
            echo "plan_failed=$failed" >> $GITHUB_OUTPUT
            
            if [ "$failed" -gt 0 ]; then
              echo "plan_status=failed" >> $GITHUB_OUTPUT
              echo "plan_message=âŒ Terraform plan failed for $failed deployment(s)" >> $GITHUB_OUTPUT
            else
              echo "plan_status=success" >> $GITHUB_OUTPUT
              echo "plan_message=âœ… Terraform plan successful for $successful deployment(s)" >> $GITHUB_OUTPUT
            fi
          else
            echo "plan_status=failed" >> $GITHUB_OUTPUT
            echo "plan_message=âŒ Plan results not generated" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¤ Upload Plan Results as Artifacts
        if: steps.plan.outputs.plan_status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-results-pr-${{ github.event.client_payload.pr_number }}
          path: |
            source-repo/plan-results.json
            source-repo/plan-markdown/*.md
            source-repo/terraform-json/*.json
          retention-days: 30

      - name: ğŸ” OPA Policy Validation
        if: steps.plan.outputs.plan_status == 'success'
        id: opa
        working-directory: source-repo
        run: |
          echo "ğŸ” Running OPA policy validation..."
          
          # Setup OPA
          curl -L -o opa https://github.com/open-policy-agent/opa/releases/download/v${{ env.OPA_VERSION }}/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/
          
          # Run OPA validation
          python ../controller/scripts/opa-validator.py \
            --terraform-json terraform-json \
            --policies ../controller/OPA-Policies/opa \
            --output opa-results.json \
            --debug
          
          if [ -f "opa-results.json" ]; then
            violations=$(jq '.summary.total_violations // 0' opa-results.json)
            passed=$(jq '.summary.total_passed // 0' opa-results.json)
            
            echo "opa_violations=$violations" >> $GITHUB_OUTPUT
            echo "opa_passed=$passed" >> $GITHUB_OUTPUT
            
            if [ "$violations" -gt 0 ]; then
              echo "opa_status=failed" >> $GITHUB_OUTPUT
              echo "opa_message=âŒ OPA validation failed with $violations violation(s)" >> $GITHUB_OUTPUT
            else
              echo "opa_status=passed" >> $GITHUB_OUTPUT
              echo "opa_message=âœ… OPA validation passed" >> $GITHUB_OUTPUT
            fi
          else
            echo "opa_status=failed" >> $GITHUB_OUTPUT
            echo "opa_message=âŒ OPA validation could not run" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ·ï¸ Smart PR Labeling
        if: always() && steps.discover.outputs.has_deployments == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const prNumber = '${{ github.event.client_payload.pr_number }}';
            const planStatus = '${{ steps.plan.outputs.plan_status }}';
            const opaStatus = '${{ steps.opa.outputs.opa_status }}';
            const securityStatus = '${{ steps.security.outputs.scan_status }}';
            const violations = '${{ steps.opa.outputs.opa_violations }}' || '0';
            const securityIssues = '${{ steps.security.outputs.failed_checks }}' || '0';
            
            console.log('ğŸ·ï¸ Adding smart labels based on validation results');
            
            // Remove existing status labels
            try {
              const existingLabels = await github.rest.issues.listLabelsOnIssue({
                owner: '${{ github.event.client_payload.source_owner }}',
                repo: '${{ github.event.client_payload.source_repo }}',
                issue_number: prNumber
              });
              
              const statusLabels = existingLabels.data.filter(label => 
                label.name.includes('validation') || 
                label.name.includes('security') ||
                label.name.includes('ready') ||
                label.name.includes('blocked') ||
                label.name.includes('terraform')
              );
              
              for (const label of statusLabels) {
                await github.rest.issues.removeLabel({
                  owner: '${{ github.event.client_payload.source_owner }}',
                  repo: '${{ github.event.client_payload.source_repo }}',
                  issue_number: prNumber,
                  name: label.name
                }).catch(() => {}); // Ignore errors for non-existent labels
              }
            } catch (e) {
              console.log('Failed to remove existing labels:', e.message);
            }
            
            // Add new labels based on validation results
            const labels = [];
            
            if (planStatus === 'success' && opaStatus === 'passed' && securityStatus === 'passed') {
              labels.push('âœ… ready-for-manual-merge');
              labels.push('ğŸ›¡ï¸ security-validated');
              labels.push('ğŸ“‹ terraform-validated');
            } else {
              if (planStatus === 'failed') {
                labels.push('âŒ terraform-plan-failed');
              }
              if (opaStatus === 'failed') {
                labels.push('ğŸš« opa-policy-violation');
              }
              if (securityStatus === 'warning') {
                labels.push('âš ï¸ security-issues');
              }
              labels.push('ğŸ”’ blocked-needs-fixes');
            }
            
            // Add labels
            for (const label of labels) {
              try {
                await github.rest.issues.addLabels({
                  owner: '${{ github.event.client_payload.source_owner }}',
                  repo: '${{ github.event.client_payload.source_repo }}',
                  issue_number: prNumber,
                  labels: [label]
                });
              } catch (e) {
                console.log(`Failed to add label ${label}:`, e.message);
              }
            }

      - name: ğŸ’¬ Enhanced PR Comments with Plan Details
        if: always() && steps.discover.outputs.has_deployments == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const prNumber = '${{ github.event.client_payload.pr_number }}';
            const deploymentCount = '${{ steps.discover.outputs.deployment_count }}';
            const planStatus = '${{ steps.plan.outputs.plan_status }}';
            const planMessage = '${{ steps.plan.outputs.plan_message }}';
            const opaStatus = '${{ steps.opa.outputs.opa_status }}';
            const opaMessage = '${{ steps.opa.outputs.opa_message }}';
            const securityStatus = '${{ steps.security.outputs.scan_status }}';
            const securityMessage = '${{ steps.security.outputs.scan_message }}';
            
            // Determine overall status
            let overallStatus = 'âœ… Ready for Manual Merge';
            let nextSteps = '**Ready for review and manual merge!**';
            
            if (planStatus === 'failed' || opaStatus === 'failed') {
              overallStatus = 'âŒ Validation Failed';
              nextSteps = '**Please fix the issues and push updates to this PR.**';
            } else if (securityStatus === 'warning') {
              overallStatus = 'âš ï¸ Security Issues Detected';
              nextSteps = '**Review security issues before merging.**';
            }
            
            // Read plan details if available
            let planDetails = '';
            try {
              const planResultsPath = 'source-repo/plan-results.json';
              if (fs.existsSync(planResultsPath)) {
                const planResults = JSON.parse(fs.readFileSync(planResultsPath, 'utf8'));
                
                planDetails = '\n### ğŸ“Š Detailed Plan Results\n';
                
                if (planResults.deployments && planResults.deployments.length > 0) {
                  for (const deployment of planResults.deployments) {
                    const status = deployment.success ? 'âœ…' : 'âŒ';
                    planDetails += `\n**${status} ${deployment.deployment_key}**\n`;
                    
                    if (deployment.plan_summary) {
                      planDetails += `- **Resources to Add:** ${deployment.plan_summary.add || 0}\n`;
                      planDetails += `- **Resources to Change:** ${deployment.plan_summary.change || 0}\n`;
                      planDetails += `- **Resources to Destroy:** ${deployment.plan_summary.destroy || 0}\n`;
                    }
                    
                    // Link to markdown plan if exists
                    const markdownFile = deployment.deployment_key.replace(/[\/\\]/g, '-') + '-plan.md';
                    planDetails += `- ğŸ“„ [View Detailed Plan](../actions/runs/${{ github.run_id }}/artifacts) (Download artifacts: ${markdownFile})\n`;
                  }
                }
                
                // Add artifact download link
                planDetails += `\n**ğŸ“¥ Download Full Plan Details:**\n`;
                planDetails += `- [Plan Results Artifacts](../actions/runs/${{ github.run_id }}/artifacts)\n`;
                planDetails += `- Includes: Terraform plans, JSON output, and markdown summaries\n`;
              }
            } catch (error) {
              console.log('Could not read plan details:', error.message);
              planDetails = '\n### ğŸ“Š Plan Details\n*Plan details will be available in workflow artifacts*\n';
            }
            
            const comment = `## ğŸ¯ Centralized Pipeline Validation Results\n\n` +
              `**ğŸ“Š Overall Status:** ${overallStatus}\n\n` +
              `### ğŸ“‹ Validation Summary\n` +
              `- **Deployments Processed:** ${deploymentCount}\n` +
              `- **Terraform Plan:** ${planMessage}\n` +
              `- **OPA Policy Check:** ${opaMessage}\n` +
              `- **Security Scan:** ${securityMessage}\n` +
              planDetails + '\n\n' +
              `### ğŸš€ Next Steps\n` +
              `${nextSteps}\n\n` +
              `### ğŸ”„ Manual Merge Process\n` +
              `After all validations pass:\n` +
              `1. âœ… Review the validation results above\n` +
              `2. âœ… Review plan details in artifacts if needed\n` +
              `3. âœ… Manually merge this PR when ready\n` +
              `4. âœ… Apply will be triggered automatically after merge\n\n` +
              `---\n` +
              `*ğŸ¤– Automated validation by Centralized Controller*\n` +
              `*â° ${new Date().toISOString()}*\n` +
              `*ğŸ“ Artifacts: [View Plan Files](../actions/runs/${{ github.run_id }}/artifacts)*`;

            await github.rest.issues.createComment({
              owner: '${{ github.event.client_payload.source_owner }}',
              repo: '${{ github.event.client_payload.source_repo }}',
              issue_number: prNumber,
              body: comment
            });

  # =============================================================================
  # APPLY JOB - Triggered after manual merge
  # =============================================================================
  terraform-apply:
    name: ğŸš€ Terraform Apply
    runs-on: ubuntu-latest
    if: github.event.action == 'terraform_apply' || github.event.client_payload.action == 'apply'
    
    steps:
      - name: ğŸ“‹ Setup & Event Details
        id: setup
        run: |
          echo "ğŸ”” Source: ${{ github.event.client_payload.source_owner }}/${{ github.event.client_payload.source_repo }}"
          echo "ğŸ¯ Action: Terraform Apply (Post-Merge)"
          echo "ğŸ“ Commit: ${{ github.event.client_payload.commit_sha }}"

      - name: ğŸ”‘ Generate GitHub App Token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.GT_APP_ID }}
          private_key: ${{ secrets.GT_APP_PRIVATE_KEY }}

      - name: ğŸ“¥ Checkout Controller Repository
        uses: actions/checkout@v4
        with:
          repository: Terraform-centilazed-pipline/centerlized-pipline-
          path: controller
          token: ${{ steps.app-token.outputs.token }}

      - name: ğŸ“¥ Checkout Source Repository (Main Branch)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.source_owner }}/${{ github.event.client_payload.source_repo }}
          ref: main
          path: source-repo
          token: ${{ steps.app-token.outputs.token }}

      - name: ğŸ Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install pyyaml requests jq yq

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: ğŸ—ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Discover Apply Deployments
        id: discover-apply
        working-directory: source-repo
        run: |
          # For apply, we want to process all valid deployments in main branch
          python ../controller/scripts/deployment-discovery.py \
            --output deployments.json
          
          if [ -f "deployments.json" ]; then
            deployments=$(jq '.deployments | length' deployments.json)
            echo "has_deployments=true" >> $GITHUB_OUTPUT
            echo "deployment_count=$deployments" >> $GITHUB_OUTPUT
            echo "ğŸ“Š Discovered $deployments deployments for apply"
          else
            echo "has_deployments=false" >> $GITHUB_OUTPUT
            echo "deployment_count=0" >> $GITHUB_OUTPUT
            echo "âš ï¸ No deployments discovered for apply"
          fi

      - name: ğŸ” Pre-Apply OPA Validation
        if: steps.discover-apply.outputs.has_deployments == 'true'
        id: pre-apply-opa
        working-directory: source-repo
        run: |
          echo "ğŸ” Running pre-apply OPA validation..."
          
          # Setup OPA
          curl -L -o opa https://github.com/open-policy-agent/opa/releases/download/v${{ env.OPA_VERSION }}/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/
          
          # Generate fresh plans for validation
          python ../controller/scripts/terraform-deployment-orchestrator.py \
            --action plan \
            --working-dir . \
            --deployments-json deployments.json \
            --output-summary pre-apply-plan-results.json \
            --debug
          
          # Validate with OPA
          python ../controller/scripts/opa-validator.py \
            --terraform-json terraform-json \
            --policies ../controller/OPA-Policies/opa \
            --output pre-apply-opa-results.json \
            --debug
          
          if [ -f "pre-apply-opa-results.json" ]; then
            violations=$(jq '.summary.total_violations // 0' pre-apply-opa-results.json)
            
            echo "pre_apply_violations=$violations" >> $GITHUB_OUTPUT
            
            if [ "$violations" -gt 0 ]; then
              echo "pre_apply_status=failed" >> $GITHUB_OUTPUT
              echo "âŒ Pre-apply OPA validation failed with $violations violation(s)"
              echo "ğŸš« APPLY BLOCKED: Policy violations detected"
              exit 1
            else
              echo "pre_apply_status=passed" >> $GITHUB_OUTPUT
              echo "âœ… Pre-apply OPA validation passed"
            fi
          else
            echo "pre_apply_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Pre-apply OPA validation could not run"
            exit 1
          fi

      - name: ğŸš€ Execute Terraform Apply
        if: steps.pre-apply-opa.outputs.pre_apply_status == 'passed'
        id: apply
        working-directory: source-repo
        run: |
          echo "ğŸš€ Executing terraform apply..."
          
          python ../controller/scripts/terraform-deployment-orchestrator.py \
            --action apply \
            --working-dir . \
            --deployments-json deployments.json \
            --output-summary apply-results.json \
            --debug
          
          if [ -f "apply-results.json" ]; then
            successful=$(jq '.summary.successful // 0' apply-results.json)
            failed=$(jq '.summary.failed // 0' apply-results.json)
            
            echo "apply_successful=$successful" >> $GITHUB_OUTPUT
            echo "apply_failed=$failed" >> $GITHUB_OUTPUT
            
            if [ "$failed" -gt 0 ]; then
              echo "apply_status=partial" >> $GITHUB_OUTPUT
              echo "âš ï¸ Apply completed with $failed failure(s) out of $((successful + failed)) deployment(s)"
            else
              echo "apply_status=success" >> $GITHUB_OUTPUT
              echo "âœ… Apply successful for all $successful deployment(s)"
            fi
          else
            echo "apply_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Apply results not generated"
          fi

      - name: ğŸ“ Apply Results Comment
        if: always() && steps.discover-apply.outputs.has_deployments == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const sourceRepo = '${{ github.event.client_payload.source_repo }}';
            const sourceOwner = '${{ github.event.client_payload.source_owner }}';
            const commitSha = '${{ github.event.client_payload.commit_sha }}';
            const applyStatus = '${{ steps.apply.outputs.apply_status }}';
            const successful = '${{ steps.apply.outputs.apply_successful }}' || '0';
            const failed = '${{ steps.apply.outputs.apply_failed }}' || '0';
            const preApplyStatus = '${{ steps.pre-apply-opa.outputs.pre_apply_status }}';
            
            let statusEmoji = 'âœ…';
            let statusText = 'Success';
            let message = `Successfully applied ${successful} deployment(s)`;
            
            if (preApplyStatus === 'failed') {
              statusEmoji = 'ğŸš«';
              statusText = 'Blocked';
              message = 'Apply blocked due to policy violations';
            } else if (applyStatus === 'partial') {
              statusEmoji = 'âš ï¸';
              statusText = 'Partial Success';
              message = `Applied ${successful} deployment(s), ${failed} failed`;
            } else if (applyStatus === 'failed') {
              statusEmoji = 'âŒ';
              statusText = 'Failed';
              message = `Apply failed for all deployments`;
            }
            
            const comment = `## ğŸš€ Terraform Apply Results\n\n` +
              `**ğŸ“Š Status:** ${statusEmoji} ${statusText}\n\n` +
              `### ğŸ“‹ Apply Summary\n` +
              `- **Total Deployments:** ${parseInt(successful) + parseInt(failed)}\n` +
              `- **Successful:** ${successful}\n` +
              `- **Failed:** ${failed}\n` +
              `- **Pre-Apply Validation:** ${preApplyStatus === 'passed' ? 'âœ… Passed' : 'âŒ Failed'}\n\n` +
              `### ğŸ“ Details\n` +
              `${message}\n\n` +
              `---\n` +
              `*ğŸ¤– Automated apply by Centralized Controller*\n` +
              `*â° ${new Date().toISOString()}*\n` +
              `*ğŸ“ Commit: ${commitSha}*`;

            // Post comment on commit
            await github.rest.repos.createCommitComment({
              owner: sourceOwner,
              repo: sourceRepo,
              commit_sha: commitSha,
              body: comment
            });