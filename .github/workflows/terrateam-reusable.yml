name: "Terrateam Reusable Workflow"

on:
  workflow_call:
    inputs:
      source_repo:
        description: "Source repo (owner/repo) containing the PR with tfvars"
        required: true
        type: string
      pr_number:
        description: "PR number in source repo"
        required: true
        type: string
      environment:
        description: "Environment name (dev/stage/prod)"
        required: false
        type: string
        default: "dev"
      runs_on:
        description: "Runs-on JSON for runner config"
        required: false
        type: string
        default: '"ubuntu-latest"'

jobs:
  terrateam:
    name: Terrateam central-run
    permissions:
      id-token: write
      contents: read
      # If you will post comments back to the source PR, you will need 'pull-requests: write' or 'issues: write'
      pull-requests: write
    runs-on: ${{ fromJSON(inputs.runs_on) }}
    timeout-minutes: 1440
    steps:
      - name: Checkout central repo
        uses: actions/checkout@v4

      - name: Prepare env variables
        run: |
          echo "SOURCE_REPO=${{ inputs.source_repo }}" >> $GITHUB_ENV
          echo "PR_NUMBER=${{ inputs.pr_number }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${{ inputs.environment }}" >> $GITHUB_ENV

      - name: Fetch tfvars from source PR
        # This script uses GH_TOKEN from secrets (see notes below)
        run: |
          mkdir -p external-tfvars
          # keep script minimal: use the GitHub API to list PR files and download any *.tfvars
          files_api="https://api.github.com/repos/${{ inputs.source_repo }}/pulls/${{ inputs.pr_number }}/files"
          page=1
          while :; do
            resp=$(curl -sS -H "Authorization: token ${GH_TOKEN}" "${files_api}?page=${page}&per_page=100")
            n=$(echo "$resp" | jq '. | length')
            if [ "$n" -eq 0 ]; then break; fi
            echo "$resp" | jq -r '.[] | select(.filename|test("\\.tfvars$")) | .raw_url' | while read -r raw; do
              fn=$(basename "$raw")
              curl -sS -H "Authorization: token ${GH_TOKEN}" "$raw" -o "external-tfvars/$fn"
            done
            page=$((page+1))
          done
          ls -la external-tfvars || true

      - name: Run Terrateam / Terraform plan (example)
        run: |
          # adjust to your central repo's plan steps or call the repo's Terrateam workflow
          # example: run terraform plan with first found var file
          if [ -n "$(ls external-tfvars/*.tfvars 2>/dev/null)" ]; then
            VARFILE=$(ls external-tfvars/*.tfvars | head -n1)
            terraform init -input=false -backend-config="key=env/${ENVIRONMENT}/central-$(date +%s).tfstate"
            terraform plan -var-file="${VARFILE}" -out=plans/plan.tfplan
          else
            echo "No tfvars in PR; running default plan"
            terraform init -input=false
            terraform plan -out=plans/plan.tfplan
          fi

      - name: Post plan summary back to source PR
        run: |
          PLAN_SUMMARY=$(terraform show -no-color plans/plan.tfplan | head -n200)
          COMMENT="{\"body\":\"Terrateam plan for PR #${{ inputs.pr_number }} (from ${{ inputs.source_repo }}):\n\n\`\`\`\n${PLAN_SUMMARY}\n\`\`\`\"}"
          curl -s -H "Authorization: token ${GH_TOKEN}" -X POST \
            -d "$COMMENT" \
            "https://api.github.com/repos/${{ inputs.source_repo }}/issues/${{ inputs.pr_number }}/comments"
