name: Terrateam Comment Handler

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  handle-comment:
    name: ðŸŽ­ Handle Terrateam Commands
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && startsWith(github.event.comment.body, 'terrateam ')
    
    steps:
      - name: ðŸ“‹ Parse Comment Command
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          echo "comment=$COMMENT" >> $GITHUB_OUTPUT
          
          # Extract command (terrateam apply, terrateam approve, etc.)
          COMMAND=$(echo "$COMMENT" | sed 's/terrateam //' | awk '{print $1}')
          echo "command=$COMMAND" >> $GITHUB_OUTPUT
          
          # Extract optional parameters
          PARAMS=$(echo "$COMMENT" | sed 's/terrateam [^ ]* //')
          echo "params=$PARAMS" >> $GITHUB_OUTPUT
          
          echo "ðŸŽ­ Command: $COMMAND"
          echo "ðŸ“ Params: $PARAMS"

      - name: Generate GitHub App Token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.GT_APP_ID }}
          private_key: ${{ secrets.GT_APP_PRIVATE_KEY }}

      - name: ðŸ” Get PR Details
        id: pr-details
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            core.setOutput('pr_author', pr.user.login);
            core.setOutput('pr_head_ref', pr.head.ref);
            core.setOutput('pr_head_sha', pr.head.sha);
            core.setOutput('pr_state', pr.state);
            
            console.log(`PR Author: ${pr.user.login}`);
            console.log(`PR State: ${pr.state}`);

      - name: Checkout Controller
        uses: actions/checkout@v4
        with:
          repository: Terraform-centilazed-pipline/centerlized-pipline-
          path: controller
          token: ${{ steps.app-token.outputs.token }}

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd controller
          pip install pyyaml requests

      - name: ðŸ” Check User Authorization
        id: auth-check
        run: |
          cd controller
          
          # Get comment author
          COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
          PR_AUTHOR="${{ steps.pr-details.outputs.pr_author }}"
          COMMAND="${{ steps.parse.outputs.command }}"
          
          echo "Comment by: $COMMENT_AUTHOR"
          echo "PR by: $PR_AUTHOR"
          echo "Command: $COMMAND"
          
          # Check if user is authorized for this command
          python3 -c "
          import yaml
          import sys
          
          # Load deployment rules
          with open('deployment-rules.yaml') as f:
              rules = yaml.safe_load(f)
          
          comment_author = '$COMMENT_AUTHOR'
          pr_author = '$PR_AUTHOR'
          command = '$COMMAND'
          
          authorized = False
          user_team = None
          
          # Check team membership
          for team_name, team_config in rules.get('teams', {}).items():
              if comment_author in team_config.get('members', []):
                  authorized = True
                  user_team = team_name
                  break
          
          # For approve commands, check if user can approve others' PRs
          if command == 'approve' and comment_author == pr_author:
              authorized = False  # Can't approve your own PR
              
          print(f'authorized={str(authorized).lower()}')
          print(f'user_team={user_team or \"none\"}')
          " > auth_result.txt
          
          # Read results
          AUTH_RESULT=$(cat auth_result.txt)
          echo "$AUTH_RESULT" >> $GITHUB_OUTPUT
          
          if grep -q "authorized=true" auth_result.txt; then
            echo "âœ… User $COMMENT_AUTHOR is authorized"
            echo "authorized=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ User $COMMENT_AUTHOR is not authorized"
            echo "authorized=false" >> $GITHUB_OUTPUT
          fi

      - name: âŒ Unauthorized Comment Response
        if: steps.auth-check.outputs.authorized == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const comment = `## âŒ Unauthorized Command
            
            **@${{ github.event.comment.user.login }}** is not authorized to execute \`terrateam ${{ steps.parse.outputs.command }}\`.
            
            **Authorized users:**
            - Team members defined in deployment-rules.yaml
            - Cannot approve your own PRs
            
            *Contact platform team for access.*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: ðŸŽ¯ Handle Approve Command
        if: steps.auth-check.outputs.authorized == 'true' && steps.parse.outputs.command == 'approve'
        id: handle-approve
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            // Add approval label
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['terrateam-approved']
            });
            
            // Get current labels to check approval status
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const labels = issue.labels.map(label => label.name);
            const hasApprovalRequired = labels.includes('approval-required');
            const approvalCount = labels.filter(l => l.startsWith('terrateam-approved')).length;
            
            console.log(`Current approval count: ${approvalCount}`);
            core.setOutput('approval_count', approvalCount);
            
            // Create approval comment
            const comment = `## âœ… Approval Granted
            
            **@${{ github.event.comment.user.login }}** approved this deployment.
            
            **Current Status:** ${approvalCount} approval(s) received
            
            ${hasApprovalRequired ? 'â³ Checking if sufficient approvals received...' : 'ðŸš€ Ready for deployment!'}
            
            *Use \`terrateam apply\` to proceed with deployment.*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: ðŸš€ Handle Apply Command
        if: steps.auth-check.outputs.authorized == 'true' && steps.parse.outputs.command == 'apply'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            // Check if PR has sufficient approvals
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const labels = issue.labels.map(label => label.name);
            const needsApproval = labels.includes('approval-required');
            const approvalCount = labels.filter(l => l.includes('approved')).length;
            
            if (needsApproval && approvalCount < 1) {
              const comment = `## âŒ Apply Blocked
              
              This PR requires approval before deployment.
              
              **Current:** ${approvalCount} approval(s)
              **Required:** At least 1 approval
              
              *Use \`terrateam approve\` first, then \`terrateam apply\`.*`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              return;
            }
            
            // Trigger deployment
            const comment = `## ðŸš€ Deployment Triggered
            
            **@${{ github.event.comment.user.login }}** initiated deployment.
            
            **Status:** Dispatching to centralized controller...
            
            *Monitor workflow progress in Actions tab.*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            // Dispatch to controller for apply
            await github.rest.repos.createDispatchEvent({
              owner: 'Terraform-centilazed-pipline',
              repo: 'centerlized-pipline-',
              event_type: 'terraform_apply',
              client_payload: {
                source_owner: context.repo.owner,
                source_repo: context.repo.repo,
                pr_number: context.issue.number,
                pr_head_ref: '${{ steps.pr-details.outputs.pr_head_ref }}',
                pr_head_sha: '${{ steps.pr-details.outputs.pr_head_sha }}',
                triggered_by: context.actor,
                action: 'apply'
              }
            });

      - name: ðŸ“‹ Handle Plan Command
        if: steps.auth-check.outputs.authorized == 'true' && steps.parse.outputs.command == 'plan'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const comment = `## ðŸ“‹ Plan Triggered
            
            **@${{ github.event.comment.user.login }}** requested fresh terraform plan.
            
            **Status:** Re-running plan validation...
            
            *Results will appear shortly.*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            // Dispatch to controller for fresh plan
            await github.rest.repos.createDispatchEvent({
              owner: 'Terraform-centilazed-pipline',
              repo: 'centerlized-pipline-',
              event_type: 'terraform_pr',
              client_payload: {
                source_owner: context.repo.owner,
                source_repo: context.repo.repo,
                pr_number: context.issue.number,
                pr_head_ref: '${{ steps.pr-details.outputs.pr_head_ref }}',
                pr_head_sha: '${{ steps.pr-details.outputs.pr_head_sha }}',
                triggered_by: context.actor,
                action: 'plan'
              }
            });

      - name: â“ Handle Unknown Command
        if: steps.auth-check.outputs.authorized == 'true' && !contains(fromJson('["approve", "apply", "plan"]'), steps.parse.outputs.command)
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const comment = `## â“ Unknown Command
            
            \`terrateam ${{ steps.parse.outputs.command }}\` is not recognized.
            
            **Available commands:**
            - \`terrateam plan\` - Generate fresh terraform plan
            - \`terrateam approve\` - Approve deployment (team members only)
            - \`terrateam apply\` - Deploy infrastructure (after approval)
            
            *Use one of the commands above.*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });